\section{纹理管理}

纹理是二维的位图. 在 yaavg 中, 纹理是资源的一种. 资源层从底层的文件或获得纹理数
据, 并使用这些数据构造纹理结构.

纹理有以下属性:

宽, 高, 格式, 不允许特效, 编号;

   不允许特效纹理仅能以它的原始图像不附带任何额外效果显示. 对于 OpenGL, 这种纹理
使用位图绘制指令直接向显卡绘制. 所谓额外效果包括缩放.

纹理状态:
插值方法; 重复方法; data 域状态(可能已经被回收了, 这时需要资源层重建.)

\subsection{作为资源的纹理}

纹理作为一种资源, 在资源层中以位图的形式存在. 位图有编号, 宽, 高等属性. 通过资源
层的 res\_load\_bitmap 获得一个位图对象.

\subsection{作为绘制对象的纹理}

考虑到 OpenGL 各个实现对纹理支持的不同, 创建纹理分成几个过程:

1. 初始化:
1.1. 创建纹理;
1.2. bind 位图;
1.3. 设置属性;
1.4. 生效;
1.5. 修改属性;
1.6. 重新生效....

2. 实际绘制:
2.1. get 纹理;
2.2. 纹理绘制;
2.3. put 纹理.

get 和 put 的含义:
根据纹理的属性不同, 以及 OpenGL 对纹理的垃圾收集(FIXME), 有些纹理使用 Lazy 模式, 当实际绘制前再真实
地再显存中创建. 这时, 使用 get 方法可以避免 lazy 创建. get 一个纹理使得它立刻被存入显存, 分配一个纹理
编号. 被 get 的纹理被垃圾收集的可能性降低. put 方法解除这种状态. 绘制时, 会调用内部方法确保纹理在
绘制的那一刻存在于显存中.

\subsection{纹理的垃圾收集}
1. 当一个纹理对象被销毁, 确保它被从显存中移出;
2. 当一个纹理对象被 get, 确保它在 get 之后存在于显存中(FIXME);
3. get 纹理时, 如果超出资源阈值, 按照 get 数的大小回收. get 数超过 100 则被认为是"绝对不可回收"的纹理.

这样的设计, 确保即使系统仅仅支持一块 64x64 的纹理, 依然能够绘制复杂的场景.

\subsection{纹理的属性}
压缩等级;

NPOT,

rectangle.

\subsection{纹理 operation}

纹理坐标的计算和 NPOT 和 rectangle 的设置有关;

\subsection{纹理的接口}

对于最上层, 剧本的写作者而言, 纹理有两种使用方式:

1. 作为主画面, 使用 draw image xxx at xx,xx 之类的指令, 特点是:
	画面较大;
	可以预测何时需要, 而提前准备好.
2. 作为界面, 用于构成窗口和图标的 bitmap, 画面比较小, 不可预测何时使用(取决于用户).


在命令层次上, 对上面两种不同应用显然应该提供不同的指令.

纹理对上层应该提供:

1. 每个纹理都有一个引用计数, 用于垃圾回收;
2. 每个纹理有两份图像: 原始 bitmap 和纹理化使用的 bitmap. 对于 OpenGL 纹理而言, 它们可能
    相同也可能不同. 后者指的是对某些超出系统能力的大纹理, 将被分割成小纹理;
3. 对于能力强的系统, 纹理化的 bitmap 和原始的 bitmap 可以是一样的.
4. 纹理的垃圾回收: 资源层可以预读纹理, 但是如果已经读取的纹理超出一个阈值, 资源层就要回收
    纹理. 同时, 如果被纹理化的位图超出显卡的能力, 在显卡层面上也要进行垃圾回收.
5. 因此纹理上有3个 flag: 1. 硬件纹理可以回收; 2. 纹理化位图可以回收; 3. 原始位图可以回收. 
   纹理库提供了设置这些 flags 的方法. 

这里约定, 纹理化位图所指向的空间如果是 NULL, 那么使用原始位图进行纹理化.

显卡纹理如果被显示地释放, 则需要立刻被移走. 这一点和原始纹理不同. 如果仅有显卡纹理而没有纹理化
位图, 则说明图上的纹理太多, 这个显卡纹理被收集了.


texture 和 video 一样使用继承.

bitmap 的结构:

长宽, 格式, 数据, ref, llist, resid, flags(?)

bitmap 的方法: get, put. put 的参数: 可选是否强制释放. 强制释放将导致 bitmap 从资源层被释放,
下次再读就必须通过文件.

纹理基类:

长宽, 格式 (从 bitmap 中复制过来的), bitmap (可以为 NULL, 仅当确定这个位图不会被引擎释放时),
属性 flags(能否从硬件中释放纹理?).



OpenGL 纹理:
纹理编号, 纹理化后的位图(如果为 NULL, 则是父类 bitmap 的 data), 


